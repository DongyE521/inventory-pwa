<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>åº“å­˜ç›˜ç‚¹ç³»ç»Ÿ</title>
  <!-- PWA é…ç½® -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="åº“å­˜ç›˜ç‚¹">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- å¤–éƒ¨èµ„æº -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- æ ¸å¿ƒæ ·å¼ï¼šç»Ÿä¸€æŒ‰é’®å¤§å°+ä¿®å¤å¸ƒå±€ -->
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 10px; 
      margin: 0; 
      padding-bottom: 200px; 
      -webkit-overflow-scrolling: touch; 
    }
   .browser-guide { 
      background: #e6f7ff; 
      border-left: 4px solid #1890ff; 
      padding: 10px 15px; 
      margin: 15px 0; 
      border-radius: 4px; 
      font-size: 14px; 
      color: #1890ff; 
    }
   .highlight { 
      color: #096dd9; 
      font-weight: bold; 
    }
    h2 { 
      text-align: center; 
      color: #333; 
      margin: 20px 0; 
      font-size: 24px; 
    }
   .summary { 
      background: #f5f7fa; 
      padding: 10px 15px; 
      border-radius: 6px; 
      margin: 10px 0; 
      display: flex; 
      justify-content: space-between; 
      font-size: 16px; 
    }
   .summary span { 
      color: #1890ff; 
      font-weight: bold; 
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 15px 0; 
      background: white; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    th, td { 
      border: 1px solid #eee; 
      padding: 10px 8px; 
      text-align: center; 
      font-size: 14px; 
    }
    th { 
      background-color: #fafafa; 
      font-weight: bold; 
      position: sticky; 
      top: 0; 
      z-index: 1; 
    }
    td[contenteditable] { 
      background: #fff8dc; 
      cursor: text; 
    }
    tr.duplicate { 
      background-color: #fff2f0; 
    }
    /* å…³é”®ä¿®å¤ï¼šç»Ÿä¸€æ‰€æœ‰æ“ä½œæŒ‰é’®å¤§å°ï¼ˆåˆ é™¤+ä¸Šä¼ +æŸ¥çœ‹ï¼‰ */
   .delete-btn, 
   .upload-img-btn, 
   .view-img-btn { 
      padding: 6px 10px; 
      font-size: 14px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      margin-right: 5px; 
      min-width: 80px; /* å›ºå®šæœ€å°å®½åº¦ï¼Œé¿å…æ–‡å­—é•¿çŸ­å¯¼è‡´æŒ‰é’®å¤§å°ä¸ä¸€ */
      box-sizing: border-box; 
      display: inline-flex; /* å‚ç›´å±…ä¸­æ–‡å­— */
      align-items: center; 
      justify-content: center; 
    }
   .delete-btn { 
      background: #ff4d4f; 
      color: white; 
    }
   .upload-img-btn { 
      background: #4CAF50; 
      color: white; 
    }
   .view-img-btn { 
      background: #2196F3; 
      color: white; 
      margin-right: 0; /* æœ€åä¸€ä¸ªæŒ‰é’®æ— å³é—´è· */
    }
   .img-file-input { 
      display: none; 
    }
    /* åº•éƒ¨æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
   .import-label { 
      flex: 1; 
      min-width: 0; 
      max-width: none; 
      height: 48px; 
      padding: 0 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: clamp(12px, 3vw, 14px); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      background: #1890ff; 
      color: white; 
      border-radius: 8px; 
      cursor: pointer; 
      text-align: center; 
      box-sizing: border-box; 
    }
    #fileInput, #batchFileInput, #materialLibFileInput { 
      display: none; 
    }
   .batch-upload { 
      margin: 15px 0; 
      padding: 15px; 
      background: #f9f9f9; 
      border-radius: 8px; 
    }
   .batch-label { 
      display: inline-block; 
      padding: 10px 15px; 
      background: #faad14; 
      color: white; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 15px; 
      margin-right: 10px; 
    }
    /* æœç´¢æ æ ·å¼ */
   .search-bar { 
      position: fixed; 
      bottom: 68px; 
      left: 0; 
      right: 0; 
      padding: 10px 15px; 
      background: white; 
      border-top: 1px solid #eee; 
      display: flex; 
      justify-content: center; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.03); 
      z-index: 10; 
    }
   .search-bar input { 
      width: calc(100% - 40px); 
      padding: 12px 15px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 15px; 
      min-height: 45px; 
      box-sizing: border-box; 
    }
    /* åº•éƒ¨æ“ä½œæ å®¹å™¨ */
   .bottom-actions { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: space-between; 
      align-items: center; 
      gap: 8px; 
      padding: 10px; 
      background: white; 
      border-top: 1px solid #eee; 
      box-sizing: border-box; 
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      z-index: 10; 
    }
    /* åº•éƒ¨æŒ‰é’®æ ·å¼ */
   .primary-btn { 
      flex: 1; 
      min-width: 0; 
      max-width: none; 
      height: 48px; 
      padding: 0 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: clamp(12px, 3vw, 14px); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      background-color: #1890ff; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      box-sizing: border-box; 
    }
    /* æ»šåŠ¨æŒ‰é’® */
   .scroll-btn { 
      position: fixed; 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      background: #1890ff; 
      color: white; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 5; 
      opacity: 0.9; 
    }
   .to-top { 
      bottom: 180px; 
      right: 15px; 
    }
   .to-bottom { 
      bottom: 115px; 
      right: 15px; 
    }
    /* æç¤ºæ¶ˆæ¯æ¡† */
   .tip { 
      position: fixed; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      padding: 12px 20px; 
      border-radius: 6px; 
      color: white; 
      background: #52c41a; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
      z-index: 100; 
      display: none; 
      font-size: 16px; 
      max-width: 80%; 
      text-align: center; 
    }
    /* å¼¹çª—æ ·å¼ï¼ˆå¯¼å‡ºé€‰æ‹©+å›¾ç‰‡é¢„è§ˆï¼‰ */
   .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
    }
   .modal-content { 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      width: 80%; 
      max-width: 300px; 
    }
   .modal-title { 
      font-size: 18px; 
      margin: 0 0 20px 0; 
      text-align: center; 
    }
   .modal-select { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      font-size: 16px; 
      margin-bottom: 20px; 
      box-sizing: border-box; 
    }
   .modal-buttons { 
      display: flex; 
      gap: 10px; 
    }
   .modal-btn { 
      flex: 1; 
      padding: 12px; 
      border-radius: 6px; 
      border: none; 
      font-size: 16px; 
      cursor: pointer; 
    }
   .modal-cancel { 
      background: #f5f5f5; 
    }
   .modal-confirm { 
      background: #1890ff; 
      color: white; 
    }
    /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
   .img-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.8); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 2000; 
      padding: 20px; 
    }
   .img-modal-content { 
      max-width: 90%; 
      max-height: 90%; 
      border: 4px solid white; 
      border-radius: 8px; 
    }
   .img-modal-close { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      color: white; 
      font-size: 30px; 
      cursor: pointer; 
    }
  </style>
</head>
<body>
  <!-- æµè§ˆå™¨é€‚é…æç¤º -->
  <div class="browser-guide">
    <p>ğŸŒ <span class="highlight">ä½¿ç”¨æç¤ºï¼š</span>å…ˆä¸Šä¼ ç‰©æ–™åº“CSVï¼Œæ–°å¢ç‰©æ–™æ—¶è¾“å…¥æ–™å·/å‹å·å¯è‡ªåŠ¨å¡«å……ä¿¡æ¯</p>
  </div>
  
  <!-- æ ‡é¢˜ä¸ç»Ÿè®¡ä¿¡æ¯ -->
  <h2>ğŸ“¦ åº“å­˜ç›˜ç‚¹ç³»ç»Ÿ</h2>
  <div class="summary">
    <div>æ€»ç‰©æ–™ç§ç±»æ•°ï¼š<span id="totalCount">0</span></div>
    <div>å·²ç›˜ç‚¹ç‰©æ–™ç§ç±»æ•°ï¼š<span id="countedCount">0</span></div>
  </div>
  
  <!-- æ‰¹é‡å¯¼å…¥åŒºåŸŸ -->
  <div class="batch-upload">
    <p>æ‰¹é‡è¿½åŠ ç›˜ç‚¹æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ï¼š</p>
    <label for="batchFileInput" class="batch-label">é€‰æ‹©ç›˜ç‚¹CSV</label>
    <input type="file" id="batchFileInput" accept=".csv">
    <span style="font-size:14px; color:#666;">æ ¼å¼ï¼šç‰©æ–™ç¼–å·,åç§°,è§„æ ¼,ç³»ç»Ÿæ•°é‡,å®é™…æ•°é‡,å­˜æ”¾ä½ç½®</span>
  </div>
  
  <!-- ç‰©æ–™åº“å•ç‹¬ä¸Šä¼ åŒºåŸŸ -->
  <div class="batch-upload" style="background:#e6f7ff;">
    <p>ğŸ“š ç‰©æ–™åº“ç®¡ç†ï¼ˆä»…ç”¨äºè‡ªåŠ¨å¡«å……ï¼‰ï¼š</p>
    <label for="materialLibFileInput" class="batch-label" style="background:#52c41a;">ä¸Šä¼ ç‰©æ–™åº“CSV</label>
    <input type="file" id="materialLibFileInput" accept=".csv">
    <button class="batch-label" style="background:#faad14;" onclick="clearMaterialLib()">æ¸…ç©ºç‰©æ–™åº“</button>
    <span style="font-size:14px; color:#666;">ç‰©æ–™åº“æ ¼å¼ï¼šç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼ï¼ˆä»…è¿™ä¸‰åˆ—ï¼‰</span>
    <p style="margin:8px 0 0 0; font-size:14px;">å½“å‰ç‰©æ–™åº“æ•°é‡ï¼š<span id="materialLibCount">0</span> ç§</p>
  </div>
  
  <!-- åº“å­˜è¡¨æ ¼ï¼ˆä¿®å¤è¡¨å¤´é—­åˆæ ‡ç­¾é”™è¯¯ï¼š<<<th> â†’ <<th>ï¼‰ -->
  <table id="inventoryTable">
    <thead>
      <tr>
        <th>åºå·</</th>
        <th>ç‰©æ–™ç¼–å·</</th>
        <th>ç‰©æ–™åç§°</</th>
        <th>è§„æ ¼</</th>
        <th>ç³»ç»Ÿæ•°é‡</</th>
        <th>å®é™…æ•°é‡</</th>
        <th>å­˜æ”¾ä½ç½®</</th>
        <th>çŠ¶æ€</</th>
        <th>æ“ä½œ</</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <!-- æœç´¢æ  -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢ç‰©æ–™ç¼–å·/åç§°/è§„æ ¼...">
  </div>
  
  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <div class="bottom-actions">
    <label for="fileInput" class="import-label">é‡æ–°å¯¼å…¥</label>
    <input type="file" id="fileInput" accept=".csv">
    <button class="primary-btn" onclick="showFormatModal()">å¯¼å‡ºæ–‡ä»¶</button>
    <button class="primary-btn" onclick="addNewItem()">æ–°å¢ç‰©æ–™</button>
    <button class="primary-btn" onclick="undoLastAction()">æ’¤å›ä¸Šä¸€æ­¥</button>
  </div>
  
  <!-- æ»šåŠ¨æŒ‰é’® -->
  <button class="scroll-btn to-top" onclick="scrollToTop()">â†‘</button>
  <button class="scroll-btn to-bottom" onclick="scrollToBottom()">â†“</button>
  
  <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— -->
  <div class="modal" id="formatModal">
    <div class="modal-content">
      <p class="modal-title">é€‰æ‹©å¯¼å‡ºæ ¼å¼</p>
      <select class="modal-select" id="exportFormat">
        <option value="csv">CSVæ ¼å¼</option>
        <option value="excel">Excelæ ¼å¼</option>
      </select>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" onclick="closeFormatModal()">å–æ¶ˆ</button>
        <button class="modal-btn modal-confirm" onclick="confirmExportFormat()">ç¡®è®¤å¯¼å‡º</button>
      </div>
    </div>
  </div>
  
  <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
  <div class="img-modal" id="imgModal">
    <span class="img-modal-close" onclick="closeImageModal()">&times;</span>
    <img class="img-modal-content" id="modalImage">
  </div>
  
  <!-- æç¤ºæ¶ˆæ¯æ¡† -->
  <div class="tip" id="tip"></div>
    <!-- Service Worker æ³¨å†Œ -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js', { scope: './' })
         .then(reg => console.log("Service Worker æ³¨å†ŒæˆåŠŸ", reg))
         .catch(err => console.log("Service Worker æ³¨å†Œå¤±è´¥", err));
      });
    }
  </script>

  <!-- æ ¸å¿ƒåŠŸèƒ½è„šæœ¬ï¼šç¬¬ä¸€æ­¥ä¿®å¤å›¾ç‰‡æŒ‰é’®åˆ‡æ¢é—®é¢˜ -->
  <script>
    // 1. åŸºç¡€å·¥å…·å‡½æ•°ï¼šé˜²æŠ–+CSVè§£æï¼ˆæ”¯æŒå«é€—å·/å¼•å·å­—æ®µï¼‰
    function debounce(func, delay) {
      let timer;
      return function() {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, arguments), delay);
      };
    }

    // ä¿®å¤CSVè§£æï¼šå¤„ç†â€œèºä¸,M5â€â€œ"ä¸»æ¿"â€ç­‰ç‰¹æ®Šå­—æ®µ
    function parseCSVLine(line) {
      const result = [];
      let currentField = '';
      let inQuotes = false; // å¼•å·å†…é€—å·ä¸è§†ä¸ºåˆ†éš”ç¬¦

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes; // åˆ‡æ¢å¼•å·çŠ¶æ€ï¼ˆå¤„ç†æˆå¯¹å¼•å·ï¼‰
        } else if (char === ',' && !inQuotes) {
          result.push(currentField.trim());
          currentField = '';
        } else {
          currentField += char;
        }
      }
      // å»é™¤å­—æ®µé¦–å°¾å¤šä½™å¼•å·ï¼ˆå¦‚â€œ"ç‰©æ–™å"â€â†’â€œç‰©æ–™åâ€ï¼‰
      result.push(currentField.trim().replace(/^"(.*)"$/, '$1'));
      return result;
    }

    // 2. å…¨å±€å˜é‡ï¼šå­˜å‚¨ç›˜ç‚¹æ•°æ®ã€ç‰©æ–™åº“ã€æ“ä½œå†å²
    let inventory = JSON.parse(localStorage.getItem("inventory")) || []; // å«å›¾ç‰‡åœ°å€
    let materialMap = JSON.parse(localStorage.getItem("materialMap")) || {}; // ç‰©æ–™åº“
    let operationHistory = []; // ç”¨äºæ’¤å›æ“ä½œ
    let currentSearchKeyword = "";

    // 3. DOMå…ƒç´ ç¼“å­˜ï¼ˆæå‰è·å–æ‰€æœ‰éœ€è¦æ“ä½œçš„å…ƒç´ ï¼‰
    const tbody = document.querySelector("#inventoryTable tbody");
    const totalCountEl = document.getElementById("totalCount");
    const countedCountEl = document.getElementById("countedCount");
    const tipEl = document.getElementById("tip");
    const searchInput = document.getElementById("searchInput");
    const formatModal = document.getElementById("formatModal");
    const imgModal = document.getElementById("imgModal");
    const modalImage = document.getElementById("modalImage");
    const materialLibCountEl = document.getElementById("materialLibCount");
    const materialLibFileInput = document.getElementById("materialLibFileInput"); // æ–°å¢ï¼šé¿å…æœªå®šä¹‰é”™è¯¯

    // 4. é¡µé¢åˆå§‹åŒ–ï¼šç»‘å®šäº‹ä»¶+åŠ è½½æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
      updateMaterialLibCount(); // åŠ è½½ç‰©æ–™åº“æ•°é‡
      materialLibFileInput.addEventListener("change", handleMaterialLibImport);
      renderTable(); // æ¸²æŸ“è¡¨æ ¼ï¼ˆæ ¸å¿ƒï¼šä¿®å¤å›¾ç‰‡æŒ‰é’®IDï¼‰
      updateSummary(); // æ›´æ–°ç»Ÿè®¡
      searchInput.addEventListener('input', handleSearch);
      document.getElementById("batchFileInput").addEventListener("change", handleBatchImport);
      document.getElementById("fileInput").addEventListener("change", handleFullImport);
    });

    // 5. è¡¨æ ¼æ¸²æŸ“ï¼šå…³é”®ä¿®å¤â€”â€”ç”¨â€œç‰©æ–™code+ç´¢å¼•â€ç”Ÿæˆç¨³å®šIDï¼ˆè§£å†³æŒ‰é’®ä¸åˆ‡æ¢ï¼‰
    function renderTable() {
      let data = [...inventory];
      // æœç´¢è¿‡æ»¤é€»è¾‘
      if (currentSearchKeyword) {
        data = data.filter(item => {
          const code = (item.code || "").toLowerCase();
          const name = (item.name || "").toLowerCase();
          const spec = (item.spec || "").toLowerCase();
          const location = (item.location || "").toLowerCase();
          return code.includes(currentSearchKeyword) || 
                 name.includes(currentSearchKeyword) || 
                 spec.includes(currentSearchKeyword) || 
                 location.includes(currentSearchKeyword);
        });
      }

      // æ¸…ç©ºè¡¨æ ¼å¹¶é‡æ–°å¡«å……
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const row = document.createElement("tr");
        if (item.duplicate) row.classList.add("duplicate");

        // ä¿®å¤1ï¼šç”Ÿæˆç¨³å®šçš„å›¾ç‰‡è¾“å…¥æ¡†IDï¼ˆç”¨code+ç´¢å¼•ï¼Œé¿å…æ•°ç»„å˜åŒ–å¯¼è‡´IDé”™ä½ï¼‰
        const itemIndex = inventory.indexOf(item); // è·å–ç‰©æ–™åœ¨åŸæ•°ç»„çš„çœŸå®ç´¢å¼•
        const imgInputId = `imgInput_${item.code || itemIndex}_${index}`; // å”¯ä¸€ID

        // ä¿®å¤ï¼šé€‚é… Blob URL é¢„è§ˆï¼ˆiOS PWA å¯ç”¨ï¼‰
const imgBtnHtml = inventory[index].imageBlobUrl ? 
  `<button class="view-img-btn" onclick="openImageModal('${inventory[index].imageBlobUrl}')">æŸ¥çœ‹å›¾ç‰‡</button>` : 
  `<label class="upload-img-btn" for="${imgInputId}">ä¸Šä¼ å›¾ç‰‡</label>
   <input type="file" id="${imgInputId}" class="img-file-input" accept="image/*" 
          onchange="handleImageUpload(${itemIndex}, this)">`;

        // è¡¨æ ¼è¡Œå†…å®¹ï¼ˆæ“ä½œåˆ—åµŒå…¥å›¾ç‰‡æŒ‰é’®ï¼‰
        row.innerHTML = `
          <td>${index + 1}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'code', this.innerText)">${item.code || ''}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'name', this.innerText)">${item.name || ''}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'spec', this.innerText)">${item.spec || ''}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'sysQty', this.innerText)">${item.sysQty || '0'}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'realQty', this.innerText)">${item.realQty || ''}</td>
          <td contenteditable="true" onblur="updateField(${itemIndex}, 'location', this.innerText)">${item.location || ''}</td>
          <td>${item.duplicate? '<span style="color:#f5222d;">é‡å¤</span>' : 'æ­£å¸¸'}</td>
          <td>
            <button class="delete-btn" onclick="deleteRow(${itemIndex})">åˆ é™¤</button>
            ${imgBtnHtml}
          </td>
        `;
        tbody.appendChild(row);
      });

      localStorage.setItem("inventory", JSON.stringify(inventory));
      updateSummary();
    }

    // ä¿®å¤ï¼šiOS PWA å…¼å®¹â€”â€”ç”¨ Blob URL æ›¿ä»£ Base64 å­˜å‚¨å›¾ç‰‡
function handleImageUpload(index, input) {
  const file = input.files[0];
  if (!file || !file.type.startsWith('image/')) {
    showTip("è¯·é€‰æ‹©JPG/PNGæ ¼å¼çš„å›¾ç‰‡", "error");
    return;
  }

  // å…³é”®ï¼šç”Ÿæˆä¸´æ—¶ Blob URLï¼ˆiOS PWA æ”¯æŒæ›´å¥½ï¼‰
  const blobUrl = URL.createObjectURL(file);
  // å­˜å‚¨ Blob URL å’Œæ–‡ä»¶åï¼ˆç”¨äºåç»­é¢„è§ˆ/æ¸…ç†ï¼‰
  inventory[index].imageBlobUrl = blobUrl;
  inventory[index].imageFileName = file.name;
  localStorage.setItem("inventory", JSON.stringify(inventory));

  // æ¸…ç©ºè¾“å…¥æ¡†+é‡æ–°æ¸²æŸ“
  input.value = "";
  renderTable(); 
  showTip("å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå¯æŸ¥çœ‹");
}

    // å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†ï¼šæ‰“å¼€
    function openImageModal(imageUrl) {
      modalImage.src = imageUrl;
      imgModal.style.display = 'flex';
    }

    // å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†ï¼šå…³é—­ï¼ˆæ¸…ç©ºåœ°å€é¿å…ç¼“å­˜ï¼‰
    function closeImageModal() {
      imgModal.style.display = 'none';
      modalImage.src = '';
    }

    // 7. æœç´¢åŠŸèƒ½ï¼šå®æ—¶è¿‡æ»¤è¡¨æ ¼æ•°æ®
    function handleSearch(e) {
      currentSearchKeyword = e.target.value.toLowerCase().trim();
      renderTable(); // æœç´¢åé‡æ–°æ¸²æŸ“
    }

    // 8. å­—æ®µç¼–è¾‘ï¼šä¿®æ”¹ç‰©æ–™ä¿¡æ¯ï¼ˆæ–™å·ã€åç§°ç­‰ï¼‰
    function updateField(index, field, value) {
      if (!inventory[index]) return;
      value = value || "";
      inventory[index][field] = value;

      // æ–™å·è‡ªåŠ¨å¡«å……ï¼ˆä»ç‰©æ–™åº“åŒ¹é…ï¼‰
      if (field === "code") {
        const code = value.trim();
        const item = inventory[index];
        if (materialMap[code] && (!item.name || !item.spec)) {
          item.name = item.name || materialMap[code].name;
          item.spec = item.spec || materialMap[code].spec;
          showTip(`å·²è‡ªåŠ¨å¡«å……æ–™å·ã€Œ${code}ã€ä¿¡æ¯`);
        }
        // æ£€æŸ¥æ–™å·é‡å¤ï¼ˆæ ‡è®°é‡å¤è¡Œï¼‰
        inventory[index].duplicate = inventory.some((item, i) => i !== index && item.code === value);
      }

      localStorage.setItem("inventory", JSON.stringify(inventory));
      renderTable();
      updateSummary();
    }
        // 9. æ–°å¢ç‰©æ–™è¡Œï¼šé€‚é…å›¾ç‰‡å­—æ®µï¼Œæ”¯æŒæ‰‹æœºç«¯è‡ªåŠ¨å¡«å……
    function addNewItem() {
      // ç”Ÿæˆå”¯ä¸€ä¸´æ—¶æ–™å·ï¼ˆé¿å…é‡å¤åˆå§‹IDï¼‰
      const newId = `WL${Date.now().toString().slice(-6)}`;
      const newItem = {
        code: newId,
        name: "",
        spec: "",
        sysQty: "0",
        realQty: "",
        location: "",
        duplicate: false,
        imageUrl: null // åˆå§‹æ— å›¾ç‰‡
      };

      // è®°å½•æ“ä½œå†å²ï¼ˆç”¨äºæ’¤å›ï¼‰
      operationHistory.push({ 
        type: 'add', 
        index: inventory.length - 1 
      });
      
      inventory.push(newItem);
      renderTable();
      showTip("æ–°å¢ç‰©æ–™è¡Œï¼Œå¯ä¸Šä¼ å›¾ç‰‡");
      scrollToBottom(); // è‡ªåŠ¨æ»šåŠ¨åˆ°æ–°å¢è¡Œ

      // æ‰‹æœºç«¯è‡ªåŠ¨å¡«å……ç›‘å¬ï¼ˆè¾“å…¥æ–™å·/è§„æ ¼åŒ¹é…ç‰©æ–™åº“ï¼‰
      setTimeout(() => {
        const rows = tbody.querySelectorAll("tr");
        const lastRow = rows[rows.length - 1];
        const rowIndex = Array.from(rows).indexOf(lastRow);
        const codeInput = lastRow.querySelector("td:nth-child(2)");
        const specInput = lastRow.querySelector("td:nth-child(4)");

        let codeAutoFilled = false;
        let specAutoFilled = false;

        // æ–™å·è¾“å…¥é˜²æŠ–åŒ¹é…
        codeInput.addEventListener("input", debounce(() => {
          const code = codeInput.innerText.trim();
          if (!codeAutoFilled && code.length >= 3 && materialMap[code] && rowIndex > -1) {
            inventory[rowIndex].name = materialMap[code].name;
            inventory[rowIndex].spec = materialMap[code].spec;
            codeAutoFilled = true;
            localStorage.setItem("inventory", JSON.stringify(inventory));
            renderTable();
            showTip(`å·²è‡ªåŠ¨å¡«å……æ–™å·ã€Œ${code}ã€`);
          }
        }, 1500));

        // è§„æ ¼è¾“å…¥é˜²æŠ–åŒ¹é…
        specInput.addEventListener("input", debounce(() => {
          const spec = specInput.innerText.trim().toLowerCase();
          if (!specAutoFilled && spec.length >= 2 && rowIndex > -1) {
            for (const code in materialMap) {
              if (materialMap[code].spec.toLowerCase().includes(spec)) {
                inventory[rowIndex].code = code;
                inventory[rowIndex].name = materialMap[code].name;
                inventory[rowIndex].spec = materialMap[code].spec;
                specAutoFilled = true;
                localStorage.setItem("inventory", JSON.stringify(inventory));
                renderTable();
                showTip(`å·²åŒ¹é…å‹å·ã€Œ${spec}ã€â†’ æ–™å·ã€Œ${code}ã€`);
                break;
              }
            }
          }
        }, 1500));
      }, 100);
    }

    // 10. åˆ é™¤ç‰©æ–™è¡Œï¼šä¿ç•™å›¾ç‰‡æ•°æ®ç”¨äºæ’¤å›
    function deleteRow(index) {
      const deletedItem = inventory[index];
      if (!deletedItem) return;

      // æ·±æ‹·è´åˆ é™¤é¡¹ï¼ˆå«å›¾ç‰‡åœ°å€ï¼Œç¡®ä¿æ’¤å›æ—¶å®Œæ•´æ¢å¤ï¼‰
      operationHistory.push({ 
        type: 'delete', 
        index: index, 
        item: JSON.parse(JSON.stringify(deletedItem)) 
      });

      inventory.splice(index, 1);
      checkAllDuplicates(); // é‡æ–°æ£€æŸ¥æ‰€æœ‰ç‰©æ–™çš„é‡å¤çŠ¶æ€
      renderTable();
      showTip(`å·²åˆ é™¤ã€Œ${deletedItem.name || 'æœªå‘½åç‰©æ–™'}ã€`);
    }

    // 11. æ’¤å›ä¸Šä¸€æ­¥æ“ä½œï¼šæ”¯æŒæ–°å¢/åˆ é™¤æ“ä½œå›æ»š
    function undoLastAction() {
      if (operationHistory.length === 0) {
        showTip("æ²¡æœ‰å¯æ’¤å›çš„æ“ä½œ", "error");
        return;
      }

      const lastOp = operationHistory.pop();
      if (lastOp.type === 'delete') {
        // æ¢å¤åˆ é™¤çš„ç‰©æ–™ï¼ˆå«å›¾ç‰‡ï¼‰
        inventory.splice(lastOp.index, 0, lastOp.item);
        checkAllDuplicates();
        localStorage.setItem("inventory", JSON.stringify(inventory));
        renderTable();
        showTip(`å·²æ¢å¤ã€Œ${lastOp.item.name || 'æœªå‘½åç‰©æ–™'}ã€`);
      } else if (lastOp.type === 'add') {
        // æ’¤å›æ–°å¢çš„ç‰©æ–™
        inventory.splice(lastOp.index, 1);
        localStorage.setItem("inventory", JSON.stringify(inventory));
        renderTable();
        showTip("å·²æ’¤å›æ–°å¢ç‰©æ–™è¡Œ");
      }
    }

    // 12. æ‰¹é‡æ£€æŸ¥é‡å¤ç‰©æ–™ï¼ˆåŸºäºæ–™å·ï¼‰
    function checkAllDuplicates() {
      inventory.forEach((item, index) => {
        item.duplicate = inventory.some((other, i) => 
          i !== index && other.code.trim() === item.code.trim() && item.code.trim() !== ""
        );
      });
    }

    // 13. ç‰©æ–™åº“å¯¼å…¥ï¼šä¿®å¤CSVè§£æï¼Œæ”¯æŒç‰¹æ®Šå­—æ®µ
    function handleMaterialLibImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          const lines = content.split("\n")
            .map(l => l.trim())
            .filter(l => l); // è¿‡æ»¤ç©ºè¡Œ

          if (lines.length === 0) {
            showTip("ç‰©æ–™åº“æ–‡ä»¶ä¸ºç©º", "error");
            return;
          }

          const newMaterialMap = {};
          lines.forEach((line, i) => {
            const cols = parseCSVLine(line); // ç”¨ä¿®å¤åçš„CSVè§£æå‡½æ•°
            // è·³è¿‡è¡¨å¤´ï¼ˆå¦‚â€œç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼â€ï¼‰
            if (i === 0 && (cols[0] === "ç‰©æ–™ç¼–å·" || cols[0] === "åºå·")) return;
            // ç‰©æ–™åº“éœ€åŒ…å«ï¼šç¼–å·ï¼ˆç¬¬1åˆ—ï¼‰ã€åç§°ï¼ˆç¬¬2åˆ—ï¼‰ã€è§„æ ¼ï¼ˆç¬¬3åˆ—ï¼‰
            if (cols.length >= 3 && cols[0].trim()) {
              newMaterialMap[cols[0].trim()] = {
                name: cols[1] || "",
                spec: cols[2] || ""
              };
            }
          });

          // åˆå¹¶ç‰©æ–™åº“ï¼ˆä¸è¦†ç›–ç°æœ‰ï¼Œä»…æ–°å¢/æ›´æ–°ï¼‰
          Object.assign(materialMap, newMaterialMap);
          localStorage.setItem("materialMap", JSON.stringify(materialMap));
          updateMaterialLibCount();
          showTip(`ç‰©æ–™åº“ä¸Šä¼ æˆåŠŸï¼šæ–°å¢/æ›´æ–° ${Object.keys(newMaterialMap).length} ç§ç‰©æ–™`);
        } catch (err) {
          showTip("ç‰©æ–™åº“å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼", "error");
          console.error("ç‰©æ–™åº“è§£æé”™è¯¯ï¼š", err);
        }
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œé¿å…é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
        this.value = "";
      };
      // ä»¥UTF-8ç¼–ç è¯»å–ï¼Œé¿å…ä¸­æ–‡ä¹±ç 
      reader.readAsText(file, "UTF-8");
    }

    // 14. æ¸…ç©ºç‰©æ–™åº“ï¼šå¸¦ç¡®è®¤æç¤º
    function clearMaterialLib() {
      if (confirm("ç¡®å®šæ¸…ç©ºç‰©æ–™åº“å—ï¼Ÿæ‰€æœ‰è‡ªåŠ¨å¡«å……è§„åˆ™å°†å¤±æ•ˆï¼")) {
        materialMap = {};
        localStorage.setItem("materialMap", JSON.stringify(materialMap));
        updateMaterialLibCount();
        showTip("ç‰©æ–™åº“å·²æ¸…ç©º");
      }
    }

    // 15. æ›´æ–°ç‰©æ–™åº“è®¡æ•°æ˜¾ç¤º
    function updateMaterialLibCount() {
      const count = Object.keys(materialMap).length;
      materialLibCountEl.textContent = count;
    }
        // 16. æ‰¹é‡å¯¼å…¥ç›˜ç‚¹æ•°æ®ï¼ˆè¿½åŠ æ¨¡å¼ï¼Œä¿®å¤CSVé”™ä½ï¼‰
    function handleBatchImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          const lines = content.split("\n")
            .map(l => l.trim())
            .filter(l => l); // è¿‡æ»¤ç©ºè¡Œ

          if (lines.length === 0) {
            showTip("ç›˜ç‚¹CSVæ–‡ä»¶ä¸ºç©º", "error");
            return;
          }

          let newCount = 0;
          lines.forEach((line, i) => {
            const cols = parseCSVLine(line); // ç”¨ä¿®å¤åçš„è§£æå‡½æ•°ï¼Œæ”¯æŒå«é€—å·å­—æ®µ
            // è·³è¿‡è¡¨å¤´ï¼ˆå¦‚â€œç‰©æ–™ç¼–å·,åç§°,è§„æ ¼,ç³»ç»Ÿæ•°é‡,å®é™…æ•°é‡,å­˜æ”¾ä½ç½®â€ï¼‰
            if (i === 0 && (cols[0] === "ç‰©æ–™ç¼–å·" || cols[0] === "åºå·")) return;
            // è‡³å°‘åŒ…å«ï¼šç¼–å·ï¼ˆç¬¬1åˆ—ï¼‰ã€åç§°ï¼ˆç¬¬2åˆ—ï¼‰ã€è§„æ ¼ï¼ˆç¬¬3åˆ—ï¼‰
            if (cols.length >= 3 && cols[0].trim()) {
              const newItem = {
                code: cols[0].trim() || "",
                name: cols[1] || "",
                spec: cols[2] || "",
                sysQty: cols[3] || "0", // ç³»ç»Ÿæ•°é‡ï¼ˆç¬¬4åˆ—ï¼Œé»˜è®¤0ï¼‰
                realQty: cols[4] || "",  // å®é™…æ•°é‡ï¼ˆç¬¬5åˆ—ï¼Œé»˜è®¤ç©ºï¼‰
                location: cols[5] || "", // å­˜æ”¾ä½ç½®ï¼ˆç¬¬6åˆ—ï¼Œé»˜è®¤ç©ºï¼‰
                duplicate: false,
                imageUrl: null // æ‰¹é‡å¯¼å…¥é»˜è®¤æ— å›¾ç‰‡
              };
              // æ£€æŸ¥æ–™å·é‡å¤
              newItem.duplicate = inventory.some(item => item.code === newItem.code);
              inventory.push(newItem);
              newCount++;
            }
          });

          checkAllDuplicates(); // æ‰¹é‡æ£€æŸ¥é‡å¤
          localStorage.setItem("inventory", JSON.stringify(inventory));
          renderTable();
          showTip(`æ‰¹é‡å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${newCount} æ¡ç‰©æ–™æ•°æ®`);
        } catch (err) {
          showTip("æ‰¹é‡å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼", "error");
          console.error("æ‰¹é‡å¯¼å…¥é”™è¯¯ï¼š", err);
        }
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        this.value = "";
      };
      reader.readAsText(file, "UTF-8");
    }

    // 17. å…¨é‡å¯¼å…¥ç›˜ç‚¹æ•°æ®ï¼ˆè¦†ç›–æ¨¡å¼ï¼Œä¿ç•™ç‰©æ–™åº“ï¼‰
    function handleFullImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          const lines = content.split("\n")
            .map(l => l.trim())
            .filter(l => l);

          if (lines.length === 0) {
            showTip("å…¨é‡å¯¼å…¥æ–‡ä»¶ä¸ºç©º", "error");
            return;
          }

          // æ¸…ç©ºç°æœ‰ç›˜ç‚¹æ•°æ®ï¼ˆç‰©æ–™åº“ä¸å˜ï¼‰
          inventory = [];
          let importCount = 0;
          lines.forEach((line, i) => {
            const cols = parseCSVLine(line);
            if (i === 0 && (cols[0] === "ç‰©æ–™ç¼–å·" || cols[0] === "åºå·")) return;
            if (cols.length >= 3 && cols[0].trim()) {
              inventory.push({
                code: cols[0].trim() || "",
                name: cols[1] || "",
                spec: cols[2] || "",
                sysQty: cols[3] || "0",
                realQty: cols[4] || "",
                location: cols[5] || "",
                duplicate: false,
                imageUrl: null
              });
              importCount++;
            }
          });

          checkAllDuplicates();
          localStorage.setItem("inventory", JSON.stringify(inventory));
          renderTable();
          showTip(`å…¨é‡å¯¼å…¥æˆåŠŸï¼šè¦†ç›–ä¸º ${importCount} æ¡ç‰©æ–™æ•°æ®`);
        } catch (err) {
          showTip("å…¨é‡å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼", "error");
          console.error("å…¨é‡å¯¼å…¥é”™è¯¯ï¼š", err);
        }
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        this.value = "";
      };
      reader.readAsText(file, "UTF-8");
    }

    // 18. å¯¼å‡ºåŠŸèƒ½ï¼šæ ¸å¿ƒä¼˜åŒ–â€”â€”è¿‡æ»¤imageUrlï¼Œé¿å…å†—ä½™å›¾ç‰‡Base64æ•°æ®
    function showFormatModal() {
      formatModal.style.display = 'flex';
    }

    function closeFormatModal() {
      formatModal.style.display = 'none';
    }

    function confirmExportFormat() {
      const format = document.getElementById("exportFormat").value;
      // è¿‡æ»¤å›¾ç‰‡å­—æ®µï¼šåªä¿ç•™æ ¸å¿ƒç›˜ç‚¹æ•°æ®ï¼Œå‰”é™¤imageUrl
      const exportData = inventory.map(item => ({
        code: item.code || "",
        name: item.name || "",
        spec: item.spec || "",
        sysQty: item.sysQty || "0",
        realQty: item.realQty || "",
        location: item.location || "",
        status: item.duplicate ? "é‡å¤" : "æ­£å¸¸" // çŠ¶æ€æ–‡å­—åŒ–ï¼Œæ›´æ˜“è¯»
      }));

      // æŒ‰é€‰æ‹©çš„æ ¼å¼å¯¼å‡º
      if (format === "csv") {
        exportToCSV(exportData);
      } else if (format === "excel") {
        exportToExcel(exportData);
      }
      closeFormatModal();
    }

    // å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼ˆå¤„ç†å­—æ®µå«é€—å·çš„æƒ…å†µï¼‰
    function exportToCSV(data) {
      // è¡¨å¤´
      const header = "ç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼,ç³»ç»Ÿæ•°é‡,å®é™…æ•°é‡,å­˜æ”¾ä½ç½®,çŠ¶æ€\n";
      // æ¯è¡Œæ•°æ®ç”¨å¼•å·åŒ…è£¹ï¼Œé¿å…é€—å·å¯¼è‡´é”™ä½
      const rows = data.map(item => 
        `"${item.code.replace(/"/g, '""')}","${item.name.replace(/"/g, '""')}","${item.spec.replace(/"/g, '""')}","${item.sysQty}","${item.realQty}","${item.location}","${item.status}"`
      ).join("\n");
      const csvContent = header + rows;

      // ç”ŸæˆUTF-8ç¼–ç çš„Blobï¼Œé¿å…ä¸­æ–‡ä¹±ç 
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const fileName = `åº“å­˜ç›˜ç‚¹æ•°æ®_${new Date().toLocaleDateString()}.csv`;
      saveAs(blob, fileName); // è°ƒç”¨FileSaveråº“ä¸‹è½½
      showTip("CSVæ–‡ä»¶å¯¼å‡ºæˆåŠŸ");
    }

    // å¯¼å‡ºä¸ºExcelæ ¼å¼ï¼ˆä¾èµ–xlsxåº“ï¼‰
    function exportToExcel(data) {
      // æ„å»ºExcelå·¥ä½œè¡¨æ•°æ®ï¼ˆè¡¨å¤´+å†…å®¹ï¼‰
      const wsData = [
        ["ç‰©æ–™ç¼–å·", "ç‰©æ–™åç§°", "è§„æ ¼", "ç³»ç»Ÿæ•°é‡", "å®é™…æ•°é‡", "å­˜æ”¾ä½ç½®", "çŠ¶æ€"], // è¡¨å¤´
        ...data.map(item => [
          item.code,
          item.name,
          item.spec,
          item.sysQty,
          item.realQty,
          item.location,
          item.status
        ])
      ];

      // åˆ›å»ºå·¥ä½œç°¿å¹¶æ·»åŠ å·¥ä½œè¡¨
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "åº“å­˜ç›˜ç‚¹"); // å·¥ä½œè¡¨åç§°

      // å¯¼å‡ºExcelæ–‡ä»¶
      const fileName = `åº“å­˜ç›˜ç‚¹æ•°æ®_${new Date().toLocaleDateString()}.xlsx`;
      XLSX.writeFile(wb, fileName);
      showTip("Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ");
    }
        // 19. è¾…åŠ©å·¥å…·å‡½æ•°ï¼šæç¤ºæ¶ˆæ¯ã€æ»šåŠ¨æ§åˆ¶ã€ç»Ÿè®¡æ›´æ–°
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ï¼ˆæ”¯æŒæˆåŠŸ/é”™è¯¯ä¸¤ç§ç±»å‹ï¼Œè‡ªåŠ¨éšè—ï¼‰
    function showTip(message, type = "success") {
      tipEl.textContent = message;
      tipEl.style.display = "block";
      // é”™è¯¯æ¶ˆæ¯çº¢è‰²èƒŒæ™¯ï¼ŒæˆåŠŸæ¶ˆæ¯ç»¿è‰²èƒŒæ™¯ï¼Œå¢å¼ºè§†è§‰åŒºåˆ†
      tipEl.style.background = type === "error" ? "#ff4d4f" : "#52c41a";
      // 3ç§’åè‡ªåŠ¨éšè—æç¤ºæ¡†
      setTimeout(() => {
        tipEl.style.display = "none";
      }, 3000);
    }

    // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨ï¼ˆå¹³æ»‘æ»šåŠ¨ï¼Œæå‡ä½“éªŒï¼‰
    function scrollToTop() {
      tbody.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // æ»šåŠ¨åˆ°è¡¨æ ¼åº•éƒ¨ï¼ˆæ–°å¢ç‰©æ–™åè‡ªåŠ¨å®šä½ï¼Œæ–¹ä¾¿ç»§ç»­æ“ä½œï¼‰
    function scrollToBottom() {
      tbody.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼šå®æ—¶æ˜¾ç¤ºâ€œæ€»ç‰©æ–™æ•°â€å’Œâ€œå·²ç›˜ç‚¹æ•°â€
    function updateSummary() {
      const totalCount = inventory.length;
      // å·²ç›˜ç‚¹åˆ¤å®šæ ‡å‡†ï¼šå®é™…æ•°é‡ï¼ˆrealQtyï¼‰éç©ºã€éç©ºæ ¼ã€é0
      const countedCount = inventory.filter(item => 
        item.realQty && item.realQty.trim() !== "" && item.realQty !== "0"
      ).length;

      // æ›´æ–°é¡µé¢æ˜¾ç¤º
      totalCountEl.textContent = totalCount;
      countedCountEl.textContent = countedCount;
    }

    // 20. çª—å£äº‹ä»¶ç›‘å¬ï¼šç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—ï¼ˆæå‡æ“ä½œä¾¿æ·æ€§ï¼‰
    window.addEventListener('click', function(e) {
      // ç‚¹å‡»å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†çš„ç©ºç™½èƒŒæ™¯ï¼Œå…³é—­é¢„è§ˆ
      if (e.target === imgModal) {
        closeImageModal();
      }
      // ç‚¹å‡»å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª—çš„ç©ºç™½èƒŒæ™¯ï¼Œå…³é—­å¼¹çª—
      if (e.target === formatModal) {
        closeFormatModal();
      }
    });

    // 21. å…¨å±€å‡½æ•°æš´éœ²ï¼ˆç¡®ä¿HTMLä¸­onclickè°ƒç”¨æ­£å¸¸ï¼Œå…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ï¼‰
    // æ³¨ï¼šè‹¥ä½¿ç”¨æ¨¡å—åŒ–å¼€å‘éœ€è°ƒæ•´ï¼Œæ­¤å¤„ä¸ºç®€åŒ–æ“ä½œä¿ç•™å…¨å±€æš´éœ²
    window.openImageModal = openImageModal;
    window.closeImageModal = closeImageModal;
    window.handleImageUpload = handleImageUpload;
    window.updateField = updateField;
    window.addNewItem = addNewItem;
    window.deleteRow = deleteRow;
    window.undoLastAction = undoLastAction;
    window.clearMaterialLib = clearMaterialLib;
    window.handleMaterialLibImport = handleMaterialLibImport;
    window.handleBatchImport = handleBatchImport;
    window.handleFullImport = handleFullImport;
    window.showFormatModal = showFormatModal;
    window.closeFormatModal = closeFormatModal;
    window.confirmExportFormat = confirmExportFormat;
    window.exportToCSV = exportToCSV;
    window.exportToExcel = exportToExcel;
    window.showTip = showTip;
    window.scrollToTop = scrollToTop;
    window.scrollToBottom = scrollToBottom;
    window.updateSummary = updateSummary;
    window.handleSearch = handleSearch;
    window.parseCSVLine = parseCSVLine;
    window.debounce = debounce;
    // é¡µé¢å…³é—­/åˆ·æ–°æ—¶ï¼Œæ¸…ç†æ‰€æœ‰ Blob URLï¼ˆé¿å… iOS å†…å­˜æ³„æ¼ï¼‰
window.addEventListener('beforeunload', function() {
  inventory.forEach(item => {
    if (item.imageBlobUrl) {
      URL.revokeObjectURL(item.imageBlobUrl); // é‡Šæ”¾èµ„æº
    }
  });
});
  </script>
</body>
</html>